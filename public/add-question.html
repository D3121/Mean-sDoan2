<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thêm câu hỏi mới</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      /* Custom scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-6">
      <!-- Form Thêm câu hỏi -->
      <form
        id="question-form"
        class="question-form bg-white p-6 rounded-xl shadow-lg w-full lg:w-1/2 max-w-md"
      >
        <h3 class="text-2xl font-semibold text-center text-gray-800 mb-6">
          Thêm câu hỏi mới
        </h3>

        <div class="mb-4">
          <label
            for="questionText"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Nội dung câu hỏi:</label
          >
          <input
            type="text"
            id="questionText"
            name="questionText"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
          />
        </div>

        <div class="mb-4">
          <label
            for="questionType"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Loại câu hỏi:</label
          >
          <select
            id="questionType"
            name="questionType"
            onchange="toggleOptions()"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
          >
            <option value="true_false">Đúng / Sai</option>
            <option value="multiple_choice">4 lựa chọn</option>
          </select>
        </div>

        <div id="true-false-options" class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Đáp án đúng:</label
          >
          <div class="flex gap-4">
            <label class="flex items-center gap-2">
              <input
                type="radio"
                name="correctAnswerTF"
                value="true"
                required
                class="h-4 w-4 text-blue-600"
              />
              Đúng
            </label>
            <label class="flex items-center gap-2">
              <input
                type="radio"
                name="correctAnswerTF"
                value="false"
                class="h-4 w-4 text-blue-600"
              />
              Sai
            </label>
          </div>
        </div>

        <div id="mcq-options" class="hidden mb-4">
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Đáp án A:</label
              >
              <input
                type="text"
                name="optionA"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              />
              <label class="flex items-center gap-2 mt-1">
                <input
                  type="radio"
                  name="correctAnswerMCQ"
                  value="A"
                  class="h-4 w-4 text-blue-600"
                />
                Đáp án đúng
              </label>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Đáp án B:</label
              >
              <input
                type="text"
                name="optionB"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              />
              <label class="flex items-center gap-2 mt-1">
                <input
                  type="radio"
                  name="correctAnswerMCQ"
                  value="B"
                  class="h-4 w-4 text-blue-600"
                />
                Đáp án đúng
              </label>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Đáp án C:</label
              >
              <input
                type="text"
                name="optionC"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              />
              <label class="flex items-center gap-2 mt-1">
                <input
                  type="radio"
                  name="correctAnswerMCQ"
                  value="C"
                  class="h-4 w-4 text-blue-600"
                />
                Đáp án đúng
              </label>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >Đáp án D:</label
              >
              <input
                type="text"
                name="optionD"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              />
              <label class="flex items-center gap-2 mt-1">
                <input
                  type="radio"
                  name="correctAnswerMCQ"
                  value="D"
                  class="h-4 w-4 text-blue-600"
                />
                Đáp án đúng
              </label>
            </div>
          </div>
        </div>

        <div class="flex justify-center gap-3">
          <button
            type="submit"
            class="add-btn bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition font-medium"
          >
            Thêm câu hỏi
          </button>
          <button
            type="button"
            onclick="cancel()"
            class="cancel-btn bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition font-medium"
          >
            Hủy
          </button>
        </div>
      </form>

      <!-- Danh sách câu hỏi -->
      <div
        class="question-list bg-white p-6 rounded-xl shadow-lg w-full lg:w-1/2 max-w-md"
      >
        <h3 class="text-2xl font-semibold text-center text-gray-800 mb-6">
          Danh sách câu hỏi
        </h3>
        <div
          id="question-list-container"
          class="max-h-[600px] overflow-y-auto custom-scrollbar"
        ></div>
      </div>
    </div>

    <!-- Modal Sửa câu hỏi -->
    <div
      id="edit-modal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md fade-in">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">
          Sửa câu hỏi
        </h3>
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Nội dung câu hỏi:</label
        >
        <input
          type="text"
          id="edit-questionText"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
        />
        <div id="edit-options" class="mb-6 space-y-3"></div>
        <div class="flex justify-center gap-3">
          <button
            onclick="saveEditQuestion()"
            class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition font-medium"
          >
            Lưu
          </button>
          <button
            onclick="closeEditModal()"
            class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition font-medium"
          >
            Hủy
          </button>
        </div>
      </div>
    </div>

    <script>
      function toggleOptions() {
  const type = document.getElementById("questionType").value;
  const tfDiv = document.getElementById("true-false-options");
  const mcqDiv = document.getElementById("mcq-options");

  const tfRadios = document.querySelectorAll('input[name="correctAnswerTF"]');
  const mcqRadios = document.querySelectorAll('input[name="correctAnswerMCQ"]');

  if (type === "true_false") {
    tfDiv.classList.remove("hidden");
    mcqDiv.classList.add("hidden");

    // TF required ON, MCQ required OFF
    tfRadios.forEach(r => r.required = true);
    mcqRadios.forEach(r => r.required = false);
  } else {
    tfDiv.classList.add("hidden");
    mcqDiv.classList.remove("hidden");

    // MCQ required ON, TF required OFF
    tfRadios.forEach(r => r.required = false);
    mcqRadios.forEach(r => r.required = true);
  }
}


      document
        .getElementById("question-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const userId = localStorage.getItem("userId");
          if (!userId) {
            window.location.href = "/login.html";
            return;
          }

          const questionText = document.getElementById("questionText").value;
          const type = document.getElementById("questionType").value;

          let correctAnswer = "";
          const payload = {
            questionText,
            type,
            correctAnswer,
            createdBy: userId,
            options: [],
          };

          if (type === "true_false") {
            const tfAnswer = document.querySelector(
              'input[name="correctAnswerTF"]:checked'
            );
            if (!tfAnswer) {
              alert("Vui lòng chọn đáp án đúng (Đúng hoặc Sai)!");
              return;
            }
            console.log("True/False answer:", tfAnswer.value);
            correctAnswer = tfAnswer.value;
            payload.correctAnswer = correctAnswer;
            payload.options = ["true", "false"];
          } else {
            const mcqAnswer = document.querySelector(
              'input[name="correctAnswerMCQ"]:checked'
            );
            if (!mcqAnswer) {
              alert("Vui lòng chọn đáp án đúng (A, B, C hoặc D)!");
              return;
            }
            const options = [
              document.querySelector('input[name="optionA"]').value,
              document.querySelector('input[name="optionB"]').value,
              document.querySelector('input[name="optionC"]').value,
              document.querySelector('input[name="optionD"]').value,
            ];
            if (options.some((opt) => !opt.trim())) {
              alert("Vui lòng nhập đầy đủ các đáp án A, B, C, D!");
              return;
            }
            console.log("MCQ answer:", mcqAnswer.value, "Options:", options);
            correctAnswer = mcqAnswer.value;
            payload.correctAnswer = correctAnswer;
            payload.options = options;
          }

          fetch("/api/questions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
              }
              return res.json();
            })
            .then((data) => {
              alert("Thêm câu hỏi thành công!");
              loadQuestionList();
              document.getElementById("question-form").reset();
              toggleOptions();
            })
            .catch((err) => {
              console.error("Error adding question:", err);
              alert("Có lỗi xảy ra khi thêm câu hỏi!");
            });
        });

      function loadQuestionList() {
        fetch("/api/questions")
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((data) => {
            const listContainer = document.getElementById(
              "question-list-container"
            );
            listContainer.innerHTML = "";
            data.forEach((question) => {
              const item = document.createElement("div");
              item.className =
                "question-item bg-gray-50 p-4 rounded-lg mb-3 shadow-sm hover:shadow-md transition";
              item.innerHTML = `
          <div class="text-gray-800 font-medium">${question.questionText}</div>
          <div class="mt-2 flex gap-2">
            <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition" onclick="editQuestion('${question._id}')">Sửa</button>
            <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition" onclick="deleteQuestion('${question._id}')">Xóa</button>
          </div>
        `;
              listContainer.appendChild(item);
            });
          })
          .catch((err) => {
            console.error("Error loading questions:", err);
            alert("Có lỗi khi tải danh sách câu hỏi: " + err.message);
          });
      }

      function deleteQuestion(id) {
        if (confirm("Bạn có chắc muốn xóa câu hỏi này không?")) {
          fetch(`/api/questions/${id}`, {
            method: "DELETE",
          })
            .then((res) => {
              if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
              }
              return res.json();
            })
            .then((data) => {
              alert("Đã xóa câu hỏi!");
              loadQuestionList();
            })
            .catch((err) => {
              console.error("Error deleting question:", err);
              alert("Có lỗi khi xóa câu hỏi!");
            });
        }
      }

      function editQuestion(id) {
        fetch(`/api/questions/${id}`)
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((q) => {
            document.getElementById("edit-modal").classList.remove("hidden");
            document.getElementById("edit-questionText").value = q.questionText;
            window.editingQuestionId = id;

            let html = "";
            if (q.type === "true_false") {
              html += `
                <div class="flex gap-4">
                  <label class="flex items-center gap-2">
                    <input type="radio" name="edit-correctAnswer" value="true" ${
                      q.correctAnswer === "true" ? "checked" : ""
                    } class="h-4 w-4 text-blue-600" /> Đúng
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="radio" name="edit-correctAnswer" value="false" ${
                      q.correctAnswer === "false" ? "checked" : ""
                    } class="h-4 w-4 text-blue-600" /> Sai
                  </label>
                </div>
              `;
            } else {
              for (let i = 0; i < q.options.length; i++) {
                const opt = q.options[i];
                const optLabel = String.fromCharCode(65 + i);
                html += `
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">${optLabel}:</label>
                    <input
                      type="text"
                      name="edit-option"
                      value="${opt}"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    />
                    <label class="flex items-center gap-2 mt-1">
                      <input
                        type="radio"
                        name="edit-correctAnswer"
                        value="${optLabel}"
                        ${q.correctAnswer === optLabel ? "checked" : ""}
                        class="h-4 w-4 text-blue-600"
                      /> Đáp án đúng
                    </label>
                  </div>
                `;
              }
            }
            document.getElementById("edit-options").innerHTML = html;
          })
          .catch((err) => {
            console.error("Error loading question:", err);
            alert("Lỗi khi tải câu hỏi để sửa!");
          });
      }

      function closeEditModal() {
        document.getElementById("edit-modal").classList.add("hidden");
      }

      function saveEditQuestion() {
        const id = window.editingQuestionId;
        const questionText = document.getElementById("edit-questionText").value;
        const correctAnswer = document.querySelector(
          'input[name="edit-correctAnswer"]:checked'
        )?.value;
        let options = [];

        if (!questionText) {
          alert("Vui lòng nhập nội dung câu hỏi!");
          return;
        }
        if (!correctAnswer) {
          alert("Vui lòng chọn đáp án đúng!");
          return;
        }

        const type =
          document.querySelector('input[name="edit-correctAnswer"]').value
            .length === 1
            ? "multiple_choice"
            : "true_false";

        if (type === "true_false") {
          options = ["true", "false"];
        } else {
          options = Array.from(
            document.querySelectorAll('input[name="edit-option"]')
          ).map((input) => input.value);
          if (options.some((opt) => !opt.trim())) {
            alert("Vui lòng nhập đầy đủ các đáp án!");
            return;
          }
        }

        const payload = {
          questionText,
          type,
          correctAnswer,
          options,
        };

        fetch(`/api/questions/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then((data) => {
            alert("Cập nhật câu hỏi thành công!");
            closeEditModal();
            loadQuestionList();
          })
          .catch((err) => {
            console.error("Error updating question:", err);
            alert("Có lỗi khi cập nhật câu hỏi!");
          });
      }

      function cancel() {
        window.location.href = "/home.html";
      }

      window.onload = function () {
        loadQuestionList();
        toggleOptions();
      };
    </script>
  </body>
</html>
