<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Làm Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      .correct-answer {
        background-color: #d1fae5;
        border-color: #10b981;
      }
      .timer {
        text-align: center;
        font-size: 1.2rem;
        color: #ef4444;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 font-sans flex items-center justify-center min-h-screen"
  >
    <div
      class="quiz-container bg-white p-6 rounded-xl shadow-lg w-full max-w-lg fade-in"
    >
      <h3
        id="question-title"
        class="text-xl font-semibold text-gray-800 mb-4 text-center"
      ></h3>
      <div id="timer" class="timer">Thời gian: 10s</div>
      <div id="question-text" class="text-gray-700 mb-6"></div>
      <div class="options space-y-3" id="question-options"></div>
      <div class="flex justify-center gap-3 mt-6">
        <button
          onclick="nextQuestion()"
          class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition font-medium"
          id="next-btn"
        >
          Tiếp theo
        </button>
      </div>
      <div id="score" class="text-center mt-4 text-lg font-semibold">
        Điểm của bạn: <span id="score-value">0</span>
      </div>
    </div>

    <script>
      let questions = [];
      let currentIndex = 0;
      let score = 0;
      let timer;
      const userId = localStorage.getItem("userId") || "";

      function startTimer() {
        let timeLeft = 10;
        document.getElementById("timer").innerText = `Thời gian: ${timeLeft}s`;
        timer = setInterval(() => {
          timeLeft--;
          document.getElementById(
            "timer"
          ).innerText = `Thời gian: ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(timer);
            autoNextQuestion();
          }
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timer);
      }

      function loadQuiz() {
        fetch(`/api/questions`)
          .then((res) => res.json())
          .then((data) => {
            if (data.length === 0) {
              alert("Không có câu hỏi nào để làm quiz!");
              window.location.href = "/home.html";
              return;
            }
            questions = data;
            showQuestion();
          })
          .catch((err) => {
            console.error("Error loading quiz:", err);
            alert("Có lỗi khi tải quiz: " + err.message);
          });
      }

      function showQuestion() {
        stopTimer();
        if (currentIndex >= questions.length) {
          updateHighScore();
          return;
        }

        const q = questions[currentIndex];
        document.getElementById("question-title").innerText = `Câu ${
          currentIndex + 1
        }/${questions.length}`;
        document.getElementById("question-text").innerText = q.questionText;

        let html = "";
        if (q.type === "true_false") {
          html += `
          <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
            <input type="radio" name="answer" value="true" class="h-4 w-4 text-blue-600" /> Đúng
          </label>
          <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
            <input type="radio" name="answer" value="false" class="h-4 w-4 text-blue-600" /> Sai
          </label>
        `;
        } else {
          for (let i = 0; i < q.options.length; i++) {
            const optLabel = String.fromCharCode(65 + i);
            html += `
            <label class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition" data-correct="${
              optLabel === q.correctAnswer
            }">
              <input type="radio" name="answer" value="${optLabel}" class="h-4 w-4 text-blue-600" />
              ${optLabel}: ${q.options[i]}
            </label>
          `;
          }
        }
        document.getElementById("question-options").innerHTML = html;
        document.getElementById("next-btn").innerText =
          currentIndex === questions.length - 1 ? "Hoàn thành" : "Tiếp theo";
        startTimer();
      }

      function nextQuestion() {
        stopTimer();
        checkAnswer();
        currentIndex++;
        setTimeout(showQuestion, 1000);
      }

      function autoNextQuestion() {
        stopTimer();
        alert("Hết giờ! Tự chuyển câu tiếp theo.");
        checkAnswer();
        currentIndex++;
        setTimeout(showQuestion, 1000);
      }

      function checkAnswer() {
        const selected = document.querySelector('input[name="answer"]:checked');
        const q = questions[currentIndex];
        const correctLabel = q.correctAnswer;
        const selectedValue = selected ? selected.value : null;

        if (selectedValue === correctLabel) {
          score += 10;
          document.getElementById("score-value").innerText = score;
          alert("Đúng! Bạn được 10 điểm.");
        } else {
          alert(`Sai! Đáp án đúng là ${correctLabel}.`);
        }

        // Tô xanh đáp án đúng
        const options = document.querySelectorAll("#question-options label");
        options.forEach((label) => {
          if (label.dataset.correct === "true") {
            label.classList.add("correct-answer");
          }
        });
      }

      function updateHighScore() {
        fetch(`/api/profile/${userId}`)
          .then((res) => res.json())
          .then((user) => {
            if (score > (user.highScore || 0)) {
              return fetch(`/api/profile/${userId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ highScore: score }),
              });
            }
          })
          .finally(() => {
            alert(`Hoàn thành quiz! Tổng điểm: ${score}`);
            window.location.href = "/home.html";
          });
      }

      window.onload = loadQuiz;
    </script>
  </body>
</html>
